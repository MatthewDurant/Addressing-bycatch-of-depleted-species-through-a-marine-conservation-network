####BYCATCH VULNERABILITY ESTIMATES - FIGURE 5####
#Calculate the latent bycatch vulnerability for each species e.g., Atl. cod
DensityCod=Density_cod
head(Density_cod)
scale_density <- function(x){(x-min(x))/(max(x)-min(x))}

DensityCod$Mean.Density_Scaled <- scale_density(Density_cod$Mean.Density)
DensityCod$Log.Density_Scaled <- scale_density(Density_cod$Log.Mean.Density)
head(DensityCod)

fisheries_data = subset(Density_had, select=Mean.Density)
fisheries_data$Mean.Density = Density_had$Mean.Density + Density_pol$Mean.Density
fisheries_data$Mean.Density_Scaled <- scale_density(fisheries_data$Mean.Density)

fisheries_data$Log.Mean.Density = log(fisheries_data$Mean.Density)
fisheries_data$log.density_scaled <- scale_density(fisheries_data$Log.Mean.Density)

DensityCod$Mean.bycatch = (DensityCod$Log.Density_Scaled) * (fisheries_data$log.density_scaled)

bv_cod = subset(DensityCod, select=Mean.bycatch)
bv_cod$Mean.bycatch <- scale_density(bv_cod$Mean.bycatch)
#High bycatch vulnerability e.g., Atl.cod - 
n = nrow(bv_cod)*0.1 #Select 10% of rows from species of interest

high_bv_cod_0.1 <- bv_cod[order(-bv_cod$Mean.bycatch),]#decending order
head(high_bv_cod_0.1)
high_bv_cod_0.1 <- high_bv_cod_0.1[1:n,] #Subset for top 10%
high_bv_cod_0.1_union <- st_union(high_bv_cod_0.1) #Form polygons from sf values

ggplot(bv_cod) + geom_sf(aes(fill=Mean.bycatch), color=NA) +
  theme_classic() +
  geom_sf(data=bras_d, fill='white', color=NA) +
  geom_sf(data=atl_coast) + scale_fill_viridis(option='H', limit=c(0,1), guide='none') +
  labs(title = 'Atlantic cod', fill='Vulnerability') +
  geom_sf(data=high_bv_cod_0.1, aes(fill=Mean.bycatch), color=NA) +
  geom_sf(data=high_bv_cod_0.1_union, color='black', size=2, fill=NA) +
  annotation_scale(width_hint=0.1)


###Combined Bycatch Vulnerability
Density_all <- subset(Density_cod, select=Mean.Density)
Density_all$Mean.Density <- Density_cod$Mean.Density + 
  Density_plaice$Mean.Density + Density_hake$Mean.Density
Density_all$log.mean_density <- log(Density_all$Mean.Density)

Density_all$log_density_scaled <- scale_density(Density_all$log.mean_density)

Density_all$Mean.bycatch <- Density_all$log_density_scaled * fisheries_data$Log.Mean.Density
bv_all <- subset(Density_all, select=Mean.bycatch)
bv_all <- Mean.bycatch <- scale_density(bv_all$Mean.bycatch)

high_bv_all_0.1 <- bv_all[order(-bv_all$Mean.bycatch),]#decending order
head(high_bv_all_0.1)
high_bv_all_0.1 <- high_bv_all_0.1[1:n,] #Subset for top 10%
high_bv_all_0.1_union <- st_union(high_bv_all_0.1) #Form polygons from sf values

ggplot(bv_all) + geom_sf(aes(fill=Mean.bycatch), color=NA) +
  theme_classic() +
  geom_sf(data=bras_d, fill='white', color=NA) +
  geom_sf(data=atl_coast) + scale_fill_viridis(option='H', limit=c(0,1), guide='none') +
  labs(title = 'Atlantic cod', fill='Vulnerability') +
  geom_sf(data=high_bv_all_0.1, aes(fill=Mean.bycatch), color=NA) +
  geom_sf(data=high_bv_all_0.1_union, color='black', size=2, fill=NA) +
  annotation_scale(width_hint=0.1)

